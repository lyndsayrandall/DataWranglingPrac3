---
title: "MVNTest"
author: "Mark Randall"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    extra_dependencies: booktabs
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      strip.white = TRUE,
                      comment = "",
                      eval = TRUE)
library(MVN)
library(mvoutlier)
library(lubridate)
library(tidyr)
library(dplyr)
library(knitr)
library(kableExtra)
library(tidyverse)
library(glue)

```

## **MVN TEST**

|  The following is a referential of test using the the following code from the url

<https://cran.r-project.org/web/packages/MVN/vignettes/MVN.html#11_The_mvn_function>  
| It demonstrates that mvn can be utilised.

```{r reference }
data(iris)
setosa <- iris[1:50, 1:4]
mvnTest = "mardia"
str(iris)
result <- mvn(data = setosa, mvnTest = "mardia")
result$multivariateNormality

```

|   Generating the plot as per course code. Note data frame has only 150 varaibles.

```{r mvnqqplot}
testIris <- iris[, 1:2]
mvnQQplot1 <- mvn(data = testIris, multivariateOutlierMethod = "quan", showOutliers = TRUE)
```

## **Larger Data Set Derived from Assessment.**

|    Thew next test will be using data generated by the assignment.
|   Read in data and test at 10,000 incidents.

```{r  readACC}

testDF <- readRDS("testDF")


testDF %<>% filter(!(is.na(Dist_GPO))) %>%
           select(Time_Float,Dist_GPO)
ss10000 <- testDF[1:10000,]
timeStartTest1 <- Sys.time()
mvnQQplot2 <- mvn(data = ss10000, multivariateOutlierMethod = "quan", showOutliers = TRUE)
timeEndTest1 <- Sys.time()
timetaken1 <- difftime(timeEndTest1,timeStartTest1, units = "secs")
cat(glue('10,000 test secs: {timetaken1}'))
```

|   Test for 20000 observations

```{r}
ss20000 <- testDF[1:20000,]
timeStartTest2 <- Sys.time()
mvnQQplot3 <- mvn(data = ss20000, multivariateOutlierMethod = "quan", showOutliers = TRUE)
timeEndTest2 <- Sys.time()
timetaken2 <- difftime(timeEndTest2,timeStartTest2, units = "secs")
cat(glue('20,000 test secs: {timetaken2}'))
```

|   Half data set at 83,000.

```{r halftest}
# ss83000 <- testDF[1:83000,]
# 
# timeStartTest3 <- Sys.time()
# mvnQQplot4 <- tryCatch({
#   mvn(data = ss83000, multivariateOutlierMethod = "quan", showOutliers = TRUE)
# }, error = function(E) {
#    cat(glue("83,000 error: {conditionMessage(E)}"))
# }, warning = function(W){
#   cat(glue("83,000 warning: {conditionMessage(W)}"))
#   
# })
# timeEndTest3 <- Sys.time()
# timetaken3 <- difftime(timeEndTest3,timeStartTest3, units = "secs")
# cat(glue('83,000 test secs: {timetaken3}'))
 
```


83,000 error: cannot allocate vector of size 51.3 Gb  
83,000 test secs: 7187.8790512085  


```{r fulltest}

timeStartTest4 <- Sys.time()
mvnQQplot5 <- tryCatch({
  mvn(data = testDF, multivariateOutlierMethod = "quan", showOutliers = TRUE)
}, error = function(E) {
   cat(glue("165,156 error: {conditionMessage(E)}"))
}, warning = function(W){
  cat(glue("165,156 warning: {conditionMessage(W)}"))
  
})
timeEndTest4 <- Sys.time()
timetaken4 <- difftime(timeEndTest4,timeStartTest4, units = "secs")
cat(glue('165,156 test secs: {timetaken4}'))
```

## **Test input against the mvoutlier package**

|   These plots were taken from the mvoutlier package.  
https://rdrr.io/cran/mvoutlier/  


#### **DDplot**
|    The function dd.plot plots the classical mahalanobis distance of the data against the robust mahalanobis distance based on the mcd estimator. Different symbols (see function symbol.plot) and colours (see function color.plot) are used depending on the mahalanobis and euclidean distance of the observations (see Filzmoser et al., 2005).

```{r ddplot}
timeStartTest5 <- Sys.time()
testDD <- dd.plot(testDF,quan= 1/2, alpha = 0.025)
timeEndTest5 <- Sys.time()
timetaken5 <- difftime(timeEndTest5,timeStartTest5, units = "secs")
cat(glue('DDplot test secs: {timetaken5}'))
```

#### **Colorplot**
|   The function color.plot plots the (two-dimensional) data using different symbols according to the robust mahalanobis distance based on the mcd estimator with adjustment and using different colors according to the euclidean distances of the observations.

```{r colorplot}
timeStartTest6 <- Sys.time()
testColorPlot <-color.plot(as.data.frame (testDF),quan= 1/2, alpha = 0.025)
timeEndTest6 <- Sys.time()
timetaken6 <- difftime(timeEndTest6,timeStartTest6, units = "secs")
cat(glue('colorplot test secs: {timetaken6}'))
```

#### **chisq.plot**
|   The function chisq.plot plots the ordered robust mahalanobis distances of the data against the quantiles of the Chi-squared distribution. By user interaction this plotting is iterated each time leaving out the observation with the greatest distance.

```{r chisq}
timeStartTest7 <- Sys.time()
testchisq <- chisq.plot(testDF, quan = 0.5, ask = FALSE)
timeEndTest7 <- Sys.time()
timetaken7 <- difftime(timeEndTest7,timeStartTest7, units = "secs")
cat(glue('chisqplot test secs: {timetaken7}'))



```


```{r sesssinfo}

sink("mvnSessionInfo.txt")
sessionInfo()
sink()

```

